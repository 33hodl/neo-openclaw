name: Bump OpenClaw Release

on:
  workflow_dispatch:
  schedule:
    - cron: "17 4 * * *"

permissions:
  contents: write
  pull-requests: write

jobs:
  bump-release:
    runs-on: ubuntu-latest
    steps:
      - name: Check out default branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.repository.default_branch }}

      - name: Find latest OpenClaw release
        id: latest
        run: |
          set -euo pipefail
          latest_tag="$(curl -fsSL https://api.github.com/repos/openclaw/openclaw/releases/latest | jq -r '.tag_name')"
          if [ -z "$latest_tag" ] || [ "$latest_tag" = "null" ]; then
            echo "Unable to determine latest release tag"
            exit 1
          fi
          echo "tag=$latest_tag" >> "$GITHUB_OUTPUT"

      - name: Compare and apply bump
        id: bump
        run: |
          set -euo pipefail

          current_tag="$(tr -d '[:space:]' < OPENCLAW_VERSION)"
          latest_tag="${{ steps.latest.outputs.tag }}"

          if [ "$current_tag" = "$latest_tag" ]; then
            echo "has_update=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          current_norm="${current_tag#v}"
          latest_norm="${latest_tag#v}"
          newer_norm="$(printf '%s\n%s\n' "$current_norm" "$latest_norm" | sort -V | tail -n1)"

          if [ "$newer_norm" != "$latest_norm" ]; then
            echo "Current pinned version ($current_tag) is newer than latest release ($latest_tag)."
            echo "has_update=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          printf '%s\n' "$latest_tag" > OPENCLAW_VERSION
          sed -i.bak -E "s/^ARG OPENCLAW_VERSION=.*/ARG OPENCLAW_VERSION=$latest_tag/" Dockerfile
          rm -f Dockerfile.bak
          sed -i.bak -E "s/currently `v[0-9.]+`/currently `$latest_tag`/" NOTES.md
          rm -f NOTES.md.bak
          sed -i.bak -E "s/example: `v[0-9.]+`/example: `$latest_tag`/" NOTES.md
          rm -f NOTES.md.bak

          echo "has_update=true" >> "$GITHUB_OUTPUT"
          echo "new_tag=$latest_tag" >> "$GITHUB_OUTPUT"

      - name: Create or update PR
        if: steps.bump.outputs.has_update == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: chore/bump-openclaw-release
          base: ${{ github.event.repository.default_branch }}
          title: "chore: bump OpenClaw to ${{ steps.bump.outputs.new_tag }}"
          commit-message: "chore: bump OpenClaw to ${{ steps.bump.outputs.new_tag }}"
          body: |
            Automated release bump.

            Changes:
            - `OPENCLAW_VERSION`
            - `Dockerfile` (`ARG OPENCLAW_VERSION`)
            - `NOTES.md`

            Safety notes:
            - Opens/updates a PR only (no direct push to default branch)
            - Never force-pushes default branch
          labels: |
            dependencies
            automation
          delete-branch: false
