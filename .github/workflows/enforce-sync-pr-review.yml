name: Enforce Sync PR Review

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  enforce-review:
    if: github.head_ref == 'chore/sync-upstream-template'
    runs-on: ubuntu-latest
    steps:
      - name: Ensure needs-review label exists
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const name = "needs-review";
            try {
              await github.rest.issues.getLabel({ owner, repo, name });
            } catch (error) {
              if (error.status === 404) {
                await github.rest.issues.createLabel({
                  owner,
                  repo,
                  name,
                  color: "d73a4a",
                  description: "Manual review required before merge",
                });
              } else {
                throw error;
              }
            }

      - name: Disable auto-merge and apply needs-review
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.payload.pull_request.number;
            const prNodeId = context.payload.pull_request.node_id;
            const autoMergeEnabled = Boolean(context.payload.pull_request.auto_merge);

            if (autoMergeEnabled) {
              await github.graphql(
                `mutation($pullRequestId: ID!) {
                  disablePullRequestAutoMerge(input: { pullRequestId: $pullRequestId }) {
                    pullRequest { id }
                  }
                }`,
                { pullRequestId: prNodeId },
              );
            }

            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: pull_number,
              labels: ["needs-review"],
            });
