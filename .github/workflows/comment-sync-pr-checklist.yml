name: Comment Sync PR Checklist

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  comment-checklist:
    if: github.event_name == 'pull_request' && github.head_ref == 'chore/sync-upstream-template'
    runs-on: ubuntu-latest
    steps:
      - name: Post or update deployment risk checklist comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const marker = '<!-- sync-risk-checklist -->';
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner,
              repo,
              pull_number: pr.number,
              per_page: 100,
            });
            const changedFiles = files.map((f) => f.filename);

            const highRiskMatchers = [
              /^render\.yaml$/,
              /^Dockerfile$/,
              /^conclave_tick\.js$/,
              /^proxy\//,
              /^proxy\/main\.go$/,
              /^proxy\/go\.mod$/,
              /^src\/.*auth.*proxy/i,
              /^src\/.*proxy.*auth/i,
              /^src\/commands\/auth.*proxy/i,
              /^src\/.*\/proxy\./i,
            ];

            const highRisk = changedFiles.filter((path) =>
              highRiskMatchers.some((rx) => rx.test(path)),
            );

            const changedFilesText = changedFiles.length
              ? changedFiles.map((f) => `- \`${f}\``).join('\n')
              : '- (none)';
            const highRiskText = highRisk.length
              ? highRisk.map((f) => `- \`${f}\``).join('\n')
              : '- none';

            const body = `${marker}
            ## Sync Deployment Risk Checklist

            This PR comes from the upstream sync branch and needs deployment-safety review.

            **Changed files**
            ${changedFilesText}

            **High-risk files/paths detected**
            ${highRiskText}

            **Checklist**
            - [ ] render.yaml unchanged or verified (PORT 8080, disk mount /data, env vars unchanged)
            - [ ] Dockerfile unchanged or verified (OPENCLAW_VERSION bump only, proxy CMD intact)
            - [ ] auth proxy still used (proxy binary + CMD points to /usr/local/bin/proxy)
            - [ ] cron jobs unaffected
            - [ ] If any high-risk files changed, DO NOT auto-merge
            `;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number: pr.number,
              per_page: 100,
            });

            const existing = comments.find(
              (c) => c.user?.type === 'Bot' && c.body?.includes(marker),
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pr.number,
                body,
              });
            }
